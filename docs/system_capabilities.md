# 系统能力与回归全景图 (System Capabilities Registry)
> L1 | 架构宪法: [CLAUDE.md](../CLAUDE.md)
> **目标**: 此文档作为系统功能的“单一事实来源 (Functional Truth)”。在开发新功能前，请查阅此地图以识别潜在的回归风险。

## 1. 提示词工坊 (Prompt Studio)

### 1.1 文本输入与交互
- **核心输入**: 
  - [ ] 支持自动高度扩展的文本框。
  - [ ] **Cmd + Enter (Mac) / Ctrl + Enter**: 触发生成 (提交至队列)。**关键点**: 必须支持队列机制，即使当前有任务在运行 (`isProcessing`) 也不能被禁用。
  - [ ] **Enter**: 普通换行。
  - [ ] **Shift + Enter**: 普通换行 (或预留给其他功能)。
- **拖拽交互 (Drag & Drop)**:
  - [ ] 将图片拖入文本框区域触发“添加参考图”。
  - [ ] 拖入 PNG 图片时，自动解析并提取元数据 (提示词、参数)。
- **剪贴板**:
  - [ ] 文本框聚焦时粘贴图片，自动添加到参考图列表。

- **工具栏与操作**:
  - [ ] **翻译**: 显式支持中/英 (CN/EN) 切换，保留原始提示词缓存。
  - [ ] **优化 (Refine)**: 支持 "优化并生成" 和 "仅优化"。
  - [ ] **逆向 (Reverse)**: 支持快速/完整模式，感知 activeModel。
  - [ ] **版本管理 (Versions)**: 支持切换不同的 Prompt Version (P1, P2...)。
  - [ ] **智能提及 (@ Mention)**: 输入 `@` 可引用原图或生成图。

### 1.3 状态管理
- **全局搜索栏 (Global Header)**:
  - [ ] 输入时实时更新 `searchQuery` 状态。
  - [ ] 回车或点击搜索图标，自动打开 **相册 (Gallery)**。
  - [ ] **约束**: 关闭相册时，必须自动清空顶部的搜索输入框。

## 2. 主视觉区 (Main Visualizer)

### 2.1 显示模式
- **单图视图**: 显示 `generatedImage` (优先显示高清原图)。
- **对比视图**: 
  - [ ] 通过开关或右键菜单 -> "加入对比" 激活。
  - [ ] 滑块交互 (Slider)。
  - [ ] **回归风险**: 确保操作“右侧”图片时，“左侧”基准图保持锁定。
- **缩放 (Zoom)**:
  - [ ] 滚轮缩放，拖拽平移。
  - [ ] 双击重置。

### 2.2 历史导航
- **缩略图栏**:
  - [ ] 与大图的 `selectedHistoryIndex` 保持同步。
  - [ ] **悬停呼出 (Hover Reveal)**: 鼠标触碰底部边缘时，历史栏标签页应自动浮出。
- **键盘导航**:
  - [ ] 左右方向键切换历史记录。
  - [ ] `Delete` 键删除当前记录 (需二次确认弹窗，输入框聚焦时除外)。

## 3. 相册系统 (Gallery & History)

### 3.1 数据完整性
- **存储**: 基于 IndexedDB/LocalStorage 的 `historyService`。
- **缩略图**:
  - [ ] 大图 (>2MB) 必须生成并存储缩略图以优化性能。
  - [ ] 相册网格视图必须实现懒加载。

### 3.2 交互
- **搜索**:
  - [ ] 基于提示词 (Prompt) 文本过滤。
  - [ ] Esc 键清空搜索或关闭相册。
- **选择**:
  - [ ] 点击缩略图进入大图详情模式。
  - [ ] 键盘方向键在网格中导航。

## 4. 工程与工作流 (Workflow)

### 4.1 多线程生成
- [ ] **队列系统**: 由 `useImageGeneration` 统一管理任务。
- [ ] **并发限制**: 默认为 3 个并发任务。
- [ ] **UI 反馈**: “生成”按钮仅在初始化时禁用，生成过程中应允许继续点击（加入队列）。

### 4.2 国际化 (i18n)
- [ ] 所有用户可见文本必须使用 `t('key')`。
- [ ] 切换语言时，所有组件即时更新显示。

### 4.3 API 与网络
- [ ] **代理支持**: 严格遵循 `X-Base-URL` 设置。
- [ ] **错误处理**: 超时或鉴权失败时，必须通过 Toast 提示用户，而不是静默失败。

## 5. 全局快捷键 (Global Shortcuts)
> **状态**: 由 `useKeyboardShortcuts` 统一管理，需防止与输入框冲突。

- [ ] **G**: 打开相册 (Gallery)。
- [ ] **H**: 打开帮助文档 (Help)。
- [ ] **N**: 重置/新建任务 (New)。
- [ ] **C**: 切换对比模式 (Compare)。
- [ ] **A**: 聚焦/添加参考图 (Append)。
- [ ] **P**: 打开提示词库 (Prompt Lab)。
- [ ] **Esc**: 关闭所有模态框 (Modal) 或退出全屏。

## 6. 智能体系统 (Agent System)

### 6.1 聊天侧边栏 (Chat Sidebar)
- [ ] **多角色协作**: 支持 Auditor (审核)、Descriptor (描述)、Architect (架构) 等角色。
- [ ] **消息流式传输**: 必须支持打字机效果 (Streaming)。
- [ ] **右侧弹出**: 点击 "Refine" 或 "Reverse" 后自动展开。

## 7. 设置与配置 (Configuration)

### 7.1 音效系统 (Sound)
- [ ] **用户偏好**: 开/关状态持久化存储。
- [ ] **触发场景**: 生成成功、生成失败、删除操作、各种 Toast 提示。

### 7.2 API 配置
- [ ] **多模式切换**: Official / Custom / Volcengine / Volcengine CN。
- [ ] **安全性**: API Key 必须通过 LocalStorage 加密或安全存储 (当前为明文存储，需注意风险)。

## 8. 提示词库 (Prompt Lab)
> **快捷键**: `P`
- [ ] **存储**: 独立的 LocalStorage 存储 (`prompt_library`)。
- [ ] **功能**:
  - [ ] **保存**: 将当前编辑区的 Prompt 保存到库。
  - [ ] **加载**: 点击卡片将 Prompt 填入编辑区 (可选覆盖或追加)。
  - [ ] **管理**: 删除、重命名 Prompt 条目。

## 9. 引导与入口 (Entry & Onboarding)
- [ ] **着陆页 (Landing Page)**:
  - [ ] 首次打开无任务时显示。
  - [ ] 提供 "开始创作" 引导按钮。
  - [ ] 快速访问 "历史记录" 或 "提示词库"。
- [ ] **文件上传**:
  - [ ] 支持 JPG/PNG/WebP 格式。
  - [ ] 拖拽上传覆盖整个编辑器区域。
